/* esm.sh - esbuild bundle(twoslash@0.1.0/core) es2022 production */
import { Buffer as __Buffer$ } from "/v135/buffer@6.0.3/es2022/buffer.mjs";
import{createSystem as ie,createFSBackedSystem as ae,createVirtualTypeScriptEnvironment as B}from"/v135/@typescript/vfs@1.5.0/es2022/vfs.mjs";var le=Object.defineProperty,ce=(t,o,a)=>o in t?le(t,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[o]=a,M=(t,o,a)=>(ce(t,typeof o!="symbol"?o+"":o,a),a),k=class extends Error{constructor(o,a,n,e){let s=`
## ${o}

${a}
`;n&&(s+=`
${n}`),e&&(s+=`
${e}`),super(s),M(this,"title"),M(this,"description"),M(this,"recommendation"),M(this,"code"),this.title=o,this.description=a,this.recommendation=n,this.code=e}},V=Object.freeze({ignoreUnknown:!1,respectType:!1,respectFunctionNames:!1,respectFunctionProperties:!1,unorderedObjects:!0,unorderedArrays:!1,unorderedSets:!1,excludeKeys:void 0,excludeValues:void 0,replacer:void 0});function fe(t,o){o?o={...V,...o}:o=V;let a=Z(o);return a.dispatch(t),a.toString()}var ue=Object.freeze(["prototype","__proto__","constructor"]);function Z(t){let o="",a=new Map,n=e=>{o+=e};return{toString(){return o},getContext(){return a},dispatch(e){return t.replacer&&(e=t.replacer(e)),this[e===null?"null":typeof e](e)},object(e){if(e&&typeof e.toJSON=="function")return this.object(e.toJSON());let s=Object.prototype.toString.call(e),i="",c=s.length;c<10?i="unknown:["+s+"]":i=s.slice(8,c-1),i=i.toLowerCase();let f=null;if((f=a.get(e))===void 0)a.set(e,a.size);else return this.dispatch("[CIRCULAR:"+f+"]");if(typeof __Buffer$<"u"&&__Buffer$.isBuffer&&__Buffer$.isBuffer(e))return n("buffer:"),n(e.toString("utf8"));if(i!=="object"&&i!=="function"&&i!=="asyncfunction")this[i]?this[i](e):t.ignoreUnknown||this.unkown(e,i);else{let d=Object.keys(e);t.unorderedObjects&&(d=d.sort());let g=[];t.respectType!==!1&&!K(e)&&(g=ue),t.excludeKeys&&(d=d.filter(w=>!t.excludeKeys(w)),g=g.filter(w=>!t.excludeKeys(w))),n("object:"+(d.length+g.length)+":");let p=w=>{this.dispatch(w),n(":"),t.excludeValues||this.dispatch(e[w]),n(",")};for(let w of d)p(w);for(let w of g)p(w)}},array(e,s){if(s=s===void 0?t.unorderedArrays!==!1:s,n("array:"+e.length+":"),!s||e.length<=1){for(let f of e)this.dispatch(f);return}let i=new Map,c=e.map(f=>{let d=Z(t);d.dispatch(f);for(let[g,p]of d.getContext())i.set(g,p);return d.toString()});return a=i,c.sort(),this.array(c,!1)},date(e){return n("date:"+e.toJSON())},symbol(e){return n("symbol:"+e.toString())},unkown(e,s){if(n(s),!!e&&(n(":"),e&&typeof e.entries=="function"))return this.array(Array.from(e.entries()),!0)},error(e){return n("error:"+e.toString())},boolean(e){return n("bool:"+e)},string(e){n("string:"+e.length+":"),n(e)},function(e){n("fn:"),K(e)?this.dispatch("[native]"):this.dispatch(e.toString()),t.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(e.name)),t.respectFunctionProperties&&this.object(e)},number(e){return n("number:"+e)},xml(e){return n("xml:"+e.toString())},null(){return n("Null")},undefined(){return n("Undefined")},regexp(e){return n("regex:"+e.toString())},uint8array(e){return n("uint8array:"),this.dispatch(Array.prototype.slice.call(e))},uint8clampedarray(e){return n("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(e))},int8array(e){return n("int8array:"),this.dispatch(Array.prototype.slice.call(e))},uint16array(e){return n("uint16array:"),this.dispatch(Array.prototype.slice.call(e))},int16array(e){return n("int16array:"),this.dispatch(Array.prototype.slice.call(e))},uint32array(e){return n("uint32array:"),this.dispatch(Array.prototype.slice.call(e))},int32array(e){return n("int32array:"),this.dispatch(Array.prototype.slice.call(e))},float32array(e){return n("float32array:"),this.dispatch(Array.prototype.slice.call(e))},float64array(e){return n("float64array:"),this.dispatch(Array.prototype.slice.call(e))},arraybuffer(e){return n("arraybuffer:"),this.dispatch(new Uint8Array(e))},url(e){return n("url:"+e.toString())},map(e){n("map:");let s=[...e];return this.array(s,t.unorderedSets!==!1)},set(e){n("set:");let s=[...e];return this.array(s,t.unorderedSets!==!1)},file(e){return n("file:"),this.dispatch([e.name,e.size,e.type,e.lastModfied])},blob(){if(t.ignoreUnknown)return n("[blob]");throw new Error(`Hashing Blob objects is currently not supported
Use "options.replacer" or "options.ignoreUnknown"
`)},domwindow(){return n("domwindow")},bigint(e){return n("bigint:"+e.toString())},process(){return n("process")},timer(){return n("timer")},pipe(){return n("pipe")},tcp(){return n("tcp")},udp(){return n("udp")},tty(){return n("tty")},statwatcher(){return n("statwatcher")},securecontext(){return n("securecontext")},connection(){return n("connection")},zlib(){return n("zlib")},context(){return n("context")},nodescript(){return n("nodescript")},httpparser(){return n("httpparser")},dataview(){return n("dataview")},signal(){return n("signal")},fsevent(){return n("fsevent")},tlswrap(){return n("tlswrap")}}}var ee="[native code] }",pe=ee.length;function K(t){return typeof t!="function"?!1:Function.prototype.toString.call(t).slice(-pe)===ee}var he={strict:!0,module:99,target:99,allowJs:!0,skipDefaultLibCheck:!0,skipLibCheck:!0},te={errors:[],noErrors:!1,noErrorsCutted:!1,noErrorValidation:!1,noStaticSemanticInfo:!1,showEmit:!1,showEmittedFile:void 0,keepNotations:!1},de=/^\/\/\s?@(\w+)$/mg,me=/^\/\/\s?@(\w+):\s?(.+)$/mg,ge=/^\s*\/\/\s*\^(\?|\||\^+)( .*)?$/mg,ye=/^\/\/\s?---cut(-before)?---$/mg,we=/^\/\/\s?---cut-after---$/mg,xe=/^\/\/\s?---cut-start---$/mg,ke=/^\/\/\s?---cut-end---$/mg;function be(t){return fe(t)}function Q(t,o){if(typeof t===o)return t;switch(o){case"number":return+t;case"string":return t;case"boolean":return t.toLowerCase()==="true"||t.length===0}throw new k("Unknown primitive value in compiler flag",`The only recognized primitives are number, string and boolean. Got ${o} with ${t}.`,"This is likely a typo.")}function z(t){let o={js:"js",javascript:"js",ts:"ts",typescript:"ts",tsx:"tsx",jsx:"jsx",json:"json",jsn:"json",map:"json",mts:"ts",cts:"ts",mjs:"js",cjs:"js"};if(o[t])return o[t];throw new k("Unknown TypeScript extension given to Twoslash",`Received ${t} but Twoslash only accepts: ${Object.keys(o)} `,"")}function ve(t,o,a){let n=[];return e(o),n;function e(s){t.forEachChild(s,i=>{if(t.isIdentifier(i)){let c=i.getText(o),f=i.getStart(o,!1)+a,d=f+c.length;n.push([f,d,c])}e(i)})}}function q(t,o){return o[0]<=t&&t<=o[1]}function $e(t,o){return o.find(a=>q(t,a))}function Te(t){t.sort((a,n)=>a[0]-n[0]);let o=[];for(let a of t){let n=o[o.length-1];n&&n[1]>=a[0]?n[1]=Math.max(n[1],a[1]):o.push(a)}return o}function J(t,o,a){let n=a.get(o.toLowerCase());if(n===void 0){let e=Array.from(a.keys());throw new k("Invalid inline compiler value",`Got ${o} for ${t} but it is not a supported value by the TS compiler.`,`Allowed values: ${e.join(",")}`)}return n}function _(t){let o=Array.from(t.matchAll(/.*?($|\n)/g)).map(e=>e[0]);function a(e){let s=e,i=0;for(let c of o){if(s<c.length)break;s-=c.length,i++}return{line:i,character:s}}function n(e,s){let i=0;for(let c=0;c<e;c++)i+=o[c].length;return i+=s,i}return{lines:o,indexToPos:a,posToIndex:n}}var Fe=/^\/\/\s?@filename: (.+)$/mg;function G(t,o,a){let n=Array.from(t.matchAll(Fe)),s=n.map(f=>f[1].trimEnd()).includes(o)?"__index__.ts":o,i=[],c=0;for(let f of n){let d=f.index,g=t.slice(c,d);g&&i.push({offset:c,filename:s,filepath:a+s,content:g,extension:R(s)}),s=f[1].trimEnd(),c=d}if(c<t.length){let f=t.slice(c);i.push({offset:c,filename:s,filepath:a+s,content:f,extension:R(s)})}return i}function R(t){return t.split(".").pop()}function W(t,o,a){let n=Te(o).sort((s,i)=>i[0]-s[0]),e=t;for(let s of n){let i=s[1]-s[0];e=e.slice(0,s[0])+e.slice(s[1]),a?.forEach(c=>{c.start+c.length<=s[0]||(c.start<s[1]?c.start=-1:c.start-=i)})}return{code:e,removals:n,nodes:a}}function Se(t,o){let a=typeof o=="string"?_(o).indexToPos:o,n=t.filter(e=>e.start>=0).sort((e,s)=>e.start-s.start||e.type.localeCompare(s.type));return n.forEach(e=>Object.assign(e,a(e.start))),n}function Y(t,o,a,n,e,s){if(e.includes(t))return{type:"tag",name:t,value:o,start:a,end:n};let i=s.find(c=>c.name.toLocaleLowerCase()===t.toLocaleLowerCase());if(i)switch(i.type){case"number":case"string":case"boolean":return{type:"compilerOptions",name:i.name,value:Q(o,i.type),start:a,end:n};case"list":{let c=i.element.type,f=o.split(","),d=typeof c=="string"?f.map(g=>Q(g,c)):f.map(g=>J(i.name,g,c));return{type:"compilerOptions",name:i.name,value:d,start:a,end:n}}default:return{type:"compilerOptions",name:i.name,value:J(i.name,o,i.type),start:a,end:n}}return Object.keys(te).includes(t)?(t==="errors"&&typeof o=="string"&&(o=o.split(" ").map(Number)),t==="noErrors"&&typeof o=="string"&&(o==="true"?o=!0:o==="false"?o=!1:o=o.split(" ").map(Number)),{type:"handbookOptions",name:t,value:o,start:a,end:n}):{type:"unknown",name:t,value:o,start:a,end:n}}function Ee(t,o,a){let n=[];return Array.from(t.matchAll(de)).forEach(e=>{let s=e.index,i=e[1];n.push(Y(i,!0,s,s+e[0].length+1,o,a))}),Array.from(t.matchAll(me)).forEach(e=>{let s=e[1];if(s==="filename")return;let i=e.index,c=e[2];n.push(Y(s,c,i,i+e[0].length+1,o,a))}),n}function Ce(t){let o=[],a=[...t.matchAll(ye)],n=[...t.matchAll(we)],e=[...t.matchAll(xe)],s=[...t.matchAll(ke)];if(a.length){let i=a[a.length-1];o.push([0,i.index+i[0].length+1])}if(n.length){let i=n[0];o.push([i.index,t.length])}if(e.length!==s.length)throw new k("Mismatched cut markers",`You have ${e.length} cut-starts and ${s.length} cut-ends`,"Make sure you have a matching pair for each.");for(let i=0;i<e.length;i++){let c=e[i],f=s[i];if(c.index>f.index)throw new k("Mismatched cut markers",`You have a cut-start at ${c.index} which is after the cut-end at ${f.index}`,"Make sure you have a matching pair for each.");o.push([c.index,f.index+f[0].length+1])}return o}function Ae(t,o,a){if(t.includes("//")){let n=new Set;Array.from(t.matchAll(ge)).forEach(e=>{let s=e[1],i=e.index;o.removals.push([i,i+e[0].length+1]);let c=e[0].indexOf("^"),f=a.indexToPos(i+c),d=f.line-1;for(;n.has(d)&&d>=0;)d-=1;let g=a.posToIndex(d,f.character);if(s==="?")o.positionQueries.push(g);else if(s==="|")o.positionCompletions.push(g);else{let p=e[0].lastIndexOf("^")-c+1;o.positionHighlights.push([g,g+p,e[2]?.trim()])}n.add(f.line)})}return o}function X(t){return t.replace(/\.map$/,"").replace(/\.d\.ts$/,".ts").replace(/\.map$/,"").replace(/\.[^/.]+$/,"")}function je(t,o,a){let n=t.filter(s=>!o.errors.includes(s.code)),e=Array.from(new Set(n.map(s=>s.code))).join(" ");if(n.length){let s=new Set(t.map(l=>l.code)),i=`// @errors: ${Array.from(s).join(" ")}`,c=o.errors.length?`
The existing annotation specified ${o.errors.join(" ")}`:`
Expected: ${i}`,f={},d=[];n.forEach(l=>{let T=l.filename?.replace(a,"");if(!T)d.push(l);else{let $=f[T];$?$.push(l):f[T]=[l]}});let g=(l,T)=>`${l}
  ${T.map($=>`[${$.code}] ${$.start} - ${$.text}`).join(`
  `)}`,p=[];d.length&&p.push(g("Ambient Errors",d)),Object.keys(f).forEach(l=>{p.push(g(l,f[l]))});let w=p.join(`

`);throw new k("Errors were thrown in the sample, but not included in an error tag",`These errors were not marked as being expected: ${e}. ${c}`,`Compiler Errors:

${w}`)}}function Oe(t={}){let o=t.tsModule,a=o.optionDeclarations,n=!!t.fsMap,e=t.vfsRoot.replace(/\\/g,"/"),s=t.fsMap||new Map,i=n?ie(s):{...ae(s,e,o,t.tsLibDirectory),realpath(p){return s.has(p)?p:o.sys.realpath?.(p)||p}},c=n?"/":`${e}/`,f=t.cache===!1?void 0:t.cache instanceof Map?t.cache:new Map;function d(p){if(!f)return B(i,[],o,p,t.customTransformers);let w=be(p);if(!f?.has(w)){let v=B(i,[],o,p,t.customTransformers);return f?.set(w,v),v}return f.get(w)}function g(p,w="ts",v={}){let l={extension:z(w),compilerOptions:{...he,...t.compilerOptions,...v.compilerOptions},handbookOptions:{...te,...t.handbookOptions,...v.handbookOptions},removals:[],flagNotations:[],virtualFiles:[],positionQueries:v.positionQueries||[],positionCompletions:v.positionCompletions||[],positionHighlights:v.positionHighlights||[]},{customTags:T=t.customTags||[],shouldGetHoverInfo:$=t.shouldGetHoverInfo||(()=>!0),filterNode:P=t.filterNode}=v,D=`index.${l.extension}`,b=[],O=r=>r>=p.length||r<0||$e(r,l.removals);l.flagNotations=Ee(p,T,a);for(let r of l.flagNotations){switch(r.type){case"unknown":continue;case"compilerOptions":l.compilerOptions[r.name]=r.value;break;case"handbookOptions":l.handbookOptions[r.name]=r.value;break;case"tag":b.push({type:"tag",name:r.name,start:r.end,length:0,text:r.value});break}l.removals.push([r.start,r.end])}if(!l.handbookOptions.noErrorValidation){let r=l.flagNotations.filter(u=>u.type==="unknown");if(r.length)throw new k("Unknown inline compiler flags",`The following flags are either valid TSConfig nor handbook options:
${r.map(u=>`@${u.name}`).join(", ")}`,"This is likely a typo, you can check all the compiler flags in the TSConfig reference, or check the additional Twoslash flags in the npm page for @typescript/twoslash.")}let j=d(l.compilerOptions),S=j.languageService,E=_(p);l.removals.push(...Ce(p)),Ae(p,l,E);let ne=["js","jsx","ts","tsx"];l.virtualFiles=G(p,D,c);let I=new Map;function L(r){if(!I.has(r.filename)){let u=j.getSourceFile(r.filepath);I.set(r.filename,ve(o,u,r.offset))}return I.get(r.filename)}function H(r){return l.virtualFiles.find(u=>q(r,[u.offset,u.offset+u.content.length]))}function U(r,u,y){let h=S.getQuickInfoAtPosition(r.filepath,u-r.offset);if(h&&h.displayParts){let m=h.displayParts.map(A=>A.text).join(""),x=h.documentation?.map(A=>A.text).join(`
`)||void 0,N=h.tags?.map(A=>[A.name,A.text?.map(se=>se.text).join("")]);return{type:"hover",text:m,docs:x,tags:N,start:u,length:y.length,target:y}}}for(let r of l.virtualFiles)(ne.includes(r.extension)||r.extension==="json"&&l.compilerOptions.resolveJsonModule)&&(r.supportLsp=!0,j.createFile(r.filepath,r.content),L(r));if(!l.handbookOptions.showEmit){for(let r of l.virtualFiles)if(r.supportLsp&&!l.handbookOptions.noStaticSemanticInfo){let u=L(r);for(let[y,h,m]of u){if(O(y)||!$(m,y,r.filename))continue;let x=U(r,y,m);x&&b.push(x)}}for(let r of l.positionQueries){if(O(r))throw new k("Invalid quick info query",`The request on line ${E.indexToPos(r).line+2} for quickinfo via ^? is in a removal range.`,"This is likely that the positioning is off.");let u=H(r),h=L(u).find(x=>q(r,x)),m;if(h&&(m=U(u,h[0],h[2])),m)m.type="query",b.push(m);else{let x=E.indexToPos(r);throw new k("Invalid quick info query",`The request on line ${x.line+2} in ${u.filename} for quickinfo via ^? returned nothing from the compiler.`,"This is likely that the positioning is off.")}}for(let r of l.positionHighlights)b.push({type:"highlight",start:r[0],length:r[1]-r[0],text:r[2]});for(let r of l.positionCompletions){let u=H(r);if(O(r)||!u)throw new k("Invalid completion query",`The request on line ${E.indexToPos(r).line+2} for completions via ^| is in a removal range.`,"This is likely that the positioning is off.");let y=p.slice(0,r).match(/[$_\w]+$/)?.[0]||"";y=y.split(".").pop();let h=[];if(y?h=(S.getCompletionsAtPosition(u.filepath,r-u.offset-1,{triggerKind:1,includeCompletionsForModuleExports:!1})?.entries??[]).filter(x=>x.name.startsWith(y))||[]:(y=p[r-1],y&&(h=S.getCompletionsAtPosition(u.filepath,r-u.offset,{triggerKind:2,triggerCharacter:y,includeCompletionsForModuleExports:!1})?.entries??[])),!h?.length&&!l.handbookOptions.noErrorValidation){let m=E.indexToPos(r);throw new k("Invalid completion query",`The request on line ${m.line} in ${u.filename} for completions via ^| returned no completions from the compiler.`,"This is likely that the positioning is off.")}b.push({type:"completion",start:r,length:0,completions:h,completionsPrefix:y})}}let C=[];for(let r of l.virtualFiles)if(r.supportLsp&&l.handbookOptions.noErrors!==!0){j.updateFile(r.filepath,r.content);let u=[...S.getSemanticDiagnostics(r.filepath),...S.getSyntacticDiagnostics(r.filepath)],y=Array.isArray(l.handbookOptions.noErrors)?l.handbookOptions.noErrors:[];for(let h of u){if(h.file?.fileName!==r.filepath||y.includes(h.code))continue;let m=h.start+r.offset;l.handbookOptions.noErrorsCutted&&O(m)||C.push({type:"error",start:m,length:h.length,code:h.code,filename:r.filename,id:`err-${h.code}-${m}-${h.length}`,text:o.flattenDiagnosticMessageText(h.messageText,`
`),level:h.category})}}P&&(b=b.filter(P),C=C.filter(P)),b.push(...C),!l.handbookOptions.noErrorValidation&&C.length&&je(C,l.handbookOptions,c);let F=p;if(l.handbookOptions.showEmit){if(l.handbookOptions.keepNotations)throw new k("Option 'showEmit' cannot be used with 'keepNotations'","With `showEmit` enabled, the output will always be the emitted code","Remove either option to continue");if(!l.handbookOptions.keepNotations){let{code:m}=W(F,l.removals),x=G(m,D,c);for(let N of x)j.updateFile(N.filepath,N.content)}let r=l.handbookOptions.showEmittedFile?l.handbookOptions.showEmittedFile:l.compilerOptions.jsx===1?"index.jsx":"index.js",u=l.virtualFiles.find(m=>X(m.filename)===X(r))?.filename;if(!u&&!l.compilerOptions.outFile){let m=l.virtualFiles.map(x=>x.filename).join(", ");throw new k("Could not find source file to show the emit for",`Cannot find the corresponding **source** file: '${r}'`,`Looked for: ${u} in the vfs - which contains: ${m}`)}l.compilerOptions.outFile&&(u=l.virtualFiles[0].filename);let y=S.getEmitOutput(c+u),h=y.outputFiles.find(m=>m.name===c+r||m.name===r);if(!h){let m=y.outputFiles.map(x=>x.name).join(", ");throw new k("Cannot find the output file in the Twoslash VFS",`Looking for ${r} in the Twoslash vfs after compiling`,`Looked for" ${c+r} in the vfs - which contains ${m}.`)}F=h.text,l.extension=z(R(h.name)),l.removals.length=0,b.length=0}if(!l.handbookOptions.keepNotations){let r=W(F,l.removals,b);F=r.code,b=r.nodes,l.removals=r.removals}let oe=F===p?E.indexToPos:_(F).indexToPos,re=Se(b,oe);return{code:F,nodes:re,meta:l,get queries(){return this.nodes.filter(r=>r.type==="query")},get completions(){return this.nodes.filter(r=>r.type==="completion")},get errors(){return this.nodes.filter(r=>r.type==="error")},get highlights(){return this.nodes.filter(r=>r.type==="highlight")},get hovers(){return this.nodes.filter(r=>r.type==="hover")},get tags(){return this.nodes.filter(r=>r.type==="tag")}}}return g.getCacheMap=()=>f,g}function Me(t,o,a){return Oe({...a,cache:!1})(t,o)}export{k as TwoslashError,_ as createPositionConverter,Oe as createTwoslasher,he as defaultCompilerOptions,te as defaultHandbookOptions,Ce as findCutNotations,Ee as findFlagNotations,Ae as findQueryMarkers,be as getObjectHash,W as removeCodeRanges,Se as resolveNodePositions,Me as twoslasher,je as validateCodeForErrors};
//# sourceMappingURL=core.js.map